{% extends 'base.html' %}

{% block content %}
<style>
  /* Dark mode styling */
  body {
    background-color: #121212;
    color: #e0e0e0;
  }
  
  html, body {
    overflow-y: hidden;
    height: 100%;
  }
  
  .chat-container {
    background-color: #121212;
    height: calc(100vh - 80px); /* ajustez selon la hauteur de votre header */
    overflow-y: hidden;
    display: flex;
    flex-direction: column;
    padding-bottom: 20px;
  }
  
  .card {
    background-color: #1e1e1e;
    border-color: #333;
    display: flex;
    flex-direction: column;
    height: 100%;
  }
  
  .card-header {
    background-color: #252525;
    border-color: #333;
    padding: 0.75rem 1rem;
  }
  
  .card-footer {
    background-color: #1e1e1e;
    border-top: 1px solid #333;
    padding: 15px;
  }
  
  .input-group .form-control {
    background-color: #2d2d2d;
    color: #e0e0e0;
    border-color: #444;
  }
  
  .input-group .form-control::placeholder {
    color: #aaa;
  }
  .chat-title {
    color: #ffffff;
    font-weight: 600;
    margin-bottom: 0;
  }
  .input-group .btn-primary {
    background-color: #0d6efd;
  }
  
  .message {
    border-bottom: 1px solid #333;
    color: white;
  }
  
  .user-message {
    background-color: #252525;
  }
  
  .staff-message {
    background-color: #1d3245;
  }
  
  /* Chat layout */
  .chat-wrapper {
    display: flex;
    gap: 20px;
    margin-top: 20px;
    flex: 1;
    min-height: 0; /* Important pour éviter le débordement */
    overflow: hidden;
  }
  
  .chat-column {
    flex: 1;
    max-width: 50%;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  
  .chat-panel {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
  }
  
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    min-height: 0; /* Important pour permettre le scroll */
  }
  
  /* Online users overlay */
  .online-users-container {
    position: relative;
    margin-bottom: 20px;
  }
  
  .online-users-button {
    width: 100%;
    text-align: left;
    background-color: #252525;
    border: 1px solid #333;
    color: #e0e0e0;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .online-users-overlay {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 1000;
    background-color: #252525;
    border: 1px solid #333;
    border-radius: 5px;
    padding: 15px;
    margin-top: 5px;
    max-height: 300px;
    overflow-y: auto;
  }
  
  .online-users-overlay.show {
    display: block;
  }
  
  .reply-info {
    display: none;
    background-color: #2d2d2d;
    padding: 8px;
    margin-bottom: 10px;
    border-radius: 4px;
  }
  
  .avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: bold;
    color: white;
  }
  
  .badge {
    margin-left: 5px;
  }
  
  .role-badge {
    background-color: #0d6efd;
    color: white;
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    margin-left: 0.25rem;
  }
  
  .header-description {
    font-size: 0.8rem;
    color: #aaa;
    margin-top: 3px;
  }
  
  .arrow-down {
    margin-left: 5px;
    width: 0;
    height: 0;
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
    border-top: 5px solid #fff;
    display: inline-block;
    vertical-align: middle;
    transition: transform 0.3s;
  }
  
  .online-users-button:hover .arrow-down {
    transform: translateY(3px);
  }
  
  .message-timestamp {
    color: #aaa;
    font-size: 0.8rem;
  }
</style>

<div id="chat-container" data-user-email="{{ user_info.email }}" data-user-id="{{user_info.id}}" data-is-staff="{{ user_info.is_staff|yesno:'true,false' }}" class="container-fluid chat-container py-4">
    
    <!-- Online Users Button -->
    <div class="online-users-container">
        <button class="online-users-button" onclick="toggleOnlineUsers()">
            <span>Utilisateurs en ligne (<span id="online-count">0</span>)</span>
            <span class="arrow-down"></span>
        </button>
        
        <div id="online-users-overlay" class="online-users-overlay">
            <h4 class="mb-3 text-white">Utilisateurs en ligne</h4>
            <ul id="online-users" class="list-group">
                <!-- Les utilisateurs en ligne seront ajoutés dynamiquement ici -->
            </ul>
        </div>
    </div>
    
    <!-- Chat Columns -->
    <div class="chat-wrapper">
        <!-- General Chat -->
        <div class="chat-column">
            <div id="general-panel" class="chat-panel">
                <div class="card chat-card">
                    <div class="card-header chat-header">
                        <h3 class="chat-title">Chat général</h3>
                        <div class="header-description">Forum général en direct</div>
                    </div>
                    <div id="general-messages" class="chat-messages">
                        {% for message in public_messages %}
                            <div class="message {% if message.is_staff %}staff-message{% else %}user-message{% endif %} p-2 mb-2" data-message-id="{{ message.id }}">
                                <strong class="text-white">
                                    {{ message.user.email }} 
                                    {% if message.is_staff %}
                                        <span class="badge bg-warning text-dark">conseiller</span>
                                    {% else %}
                                        <span class="role-badge">utilisateur</span>
                                    {% endif %}
                                </strong>
                                <span class="message-timestamp">{{ message.formatted_timestamp|date:"d/m H:i" }}</span>
                                <div class="text-white">{{ message.content }}</div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="card-footer">
                        <form id="general-form">
                            <div class="input-group">
                                <input type="text" id="general-input" class="form-control" placeholder="Tapez votre message...">
                                <button type="submit" class="btn btn-primary">Envoyer</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Private Chat -->
        <div class="chat-column">
            <div id="private-panel" class="chat-panel">
                <div class="card chat-card">
                    <div class="card-header chat-header private-header">
                        <h3 class="chat-title">Chat privé</h3>
                        <div class="header-description">Contactez un assistant qui vous répondra dans la minute</div>
                    </div>
                    <div id="private-messages" class="chat-messages">
                        {% for message in private_messages %}
                            <div class="message {% if message.is_staff %}staff-message{% else %}user-message{% endif %} p-2 mb-2" 
                                 data-message-id="{{ message.id }}" 
                                 data-user-id="{{ message.user.id }}" 
                                 data-user-email="{{ message.user.email }}">
                                <strong class="text-white">
                                    {{ message.user.email }} 
                                    {% if message.is_staff %}
                                        <span class="badge bg-warning text-dark">conseiller</span>
                                    {% else %}
                                        <span class="role-badge">utilisateur</span>
                                    {% endif %}
                                </strong>
                                <span class="message-timestamp">{{ message.formatted_timestamp|date:"d/m H:i" }}</span>
                                <div class="text-white">{{ message.content }}</div>
                                {% if user_info.is_staff and not message.is_staff %}
                                <div class="reply-actions mt-1">
                                    <button class="reply-btn btn btn-sm btn-outline-light" onclick="replyToMessage('{{ message.id }}', '{{ message.user.id }}', '{{ message.user.email }}')">Répondre</button>
                                </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                    <div class="card-footer">
                        <div id="reply-info" class="reply-info">
                            Réponse à <span id="reply-user"></span>
                            <button type="button" class="btn-close float-end" onclick="cancelReply()"></button>
                        </div>
                        <form id="private-form">
                            <input type="hidden" id="recipient-id" value="">
                            <input type="hidden" id="reply-to-id" value="">
                            <div class="input-group">
                                <input type="text" id="private-input" class="form-control" placeholder="Message privé...">
                                <button type="submit" class="btn btn-primary">Envoyer</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Toggle online users overlay
    function toggleOnlineUsers() {
        const overlay = document.getElementById('online-users-overlay');
        overlay.classList.toggle('show');
    }
    
    // Format date: converts "DD-MM-YYYY HH:MM" to "DD/MM HH:MM"
    function formatDate(dateStr) {
        if (!dateStr) return '';
        const parts = dateStr.split(' ');
        if (parts.length !== 2) return dateStr;
        
        const dateParts = parts[0].split('-');
        if (dateParts.length !== 3) return dateStr;
        
        return `${dateParts[0]}/${dateParts[1]} ${parts[1]}`;
    }
    
    // Function to reply to a message
    function replyToMessage(messageId, userId, userEmail) {
        document.getElementById('recipient-id').value = userId;
        document.getElementById('reply-to-id').value = messageId;
        
        const username = userEmail.split('@')[0];
        document.getElementById('reply-user').textContent = username;
        document.getElementById('reply-info').style.display = 'block';
        
        // Focus on input field
        document.getElementById('private-input').focus();
    }
    
    // Function to cancel reply
    function cancelReply() {
        document.getElementById('recipient-id').value = '';
        document.getElementById('reply-to-id').value = '';
        document.getElementById('reply-info').style.display = 'none';
    }
    
    // Close the overlay when clicking outside of it
    document.addEventListener('click', function(event) {
        const overlay = document.getElementById('online-users-overlay');
        const button = document.querySelector('.online-users-button');
        
        if (overlay.classList.contains('show') && 
            !overlay.contains(event.target) && 
            !button.contains(event.target)) {
            overlay.classList.remove('show');
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        console.log("Chat script initialized");
        
        // DOM elements
        const generalMessages = document.getElementById('general-messages');
        const generalForm = document.getElementById('general-form');
        const generalInput = document.getElementById('general-input');
        
        const privateMessages = document.getElementById('private-messages');
        const privateForm = document.getElementById('private-form');
        const privateInput = document.getElementById('private-input');
        const recipientId = document.getElementById('recipient-id');
        const replyToId = document.getElementById('reply-to-id');
        const replyInfo = document.getElementById('reply-info');
        const replyUser = document.getElementById('reply-user');
        
        const onlineUsers = document.getElementById('online-users');
        const onlineCount = document.getElementById('online-count');
        const chatContainer = document.getElementById('chat-container');
        
        // User data
        const currentUserEmail = chatContainer.dataset.userEmail;
        const currentUserId = chatContainer.dataset.userId;
        const isStaff = chatContainer.dataset.isStaff === 'true';
        
        console.log("User info:", currentUserEmail, isStaff);
        
        // Scroll to bottom of messages
        generalMessages.scrollTop = generalMessages.scrollHeight;
        privateMessages.scrollTop = privateMessages.scrollHeight;
        
        // Format existing usernames
        function formatExistingUsernames() {
            document.querySelectorAll('.message strong').forEach(element => {
                const text = element.childNodes[0].textContent.trim();
                if (text.includes('@')) {
                    const username = text.split('@')[0];
                    element.childNodes[0].textContent = username + ' ';
                }
            });
        }
        
        formatExistingUsernames();
        
        // Online users list
        const onlineUsersList = new Set();
        
        // Add current user
        if (currentUserEmail) {
            onlineUsersList.add(currentUserEmail);
            updateOnlineUsersList();
        }
        
        // Connect WebSocket with error handling and reconnection
        let chatSocket;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        
        function connectWebSocket() {
            console.log("Connecting to WebSocket...");
            
            try {
                // Create new WebSocket connection
                chatSocket = new WebSocket(
                    'ws://' + window.location.host + '/ws/chat/'
                );
                
                chatSocket.onopen = function(e) {
                    console.log('WebSocket connection established');
                    reconnectAttempts = 0; // Reset attempt counter
                    
                    // Announce user joining chat
                    if (currentUserEmail) {
                        try {
                            chatSocket.send(JSON.stringify({
                                'type': 'user_join',
                                'user': currentUserEmail
                            }));
                        } catch (error) {
                            console.error("Error sending join event:", error);
                        }
                    }
                };
                
                chatSocket.onmessage = function(e) {
                    try {
                        const data = JSON.parse(e.data);
                        
                        if (data.type === 'message') {
                            // Public message
                            const message = data.message;
                            const username = message.user_email.split('@')[0];
                            const formattedDate = formatDate(message.timestamp);
                            
                            const messageElement = document.createElement('div');
                            messageElement.className = `message ${message.is_staff ? 'staff-message' : 'user-message'} p-2 mb-2`;
                            messageElement.dataset.messageId = message.id;
                            
                            messageElement.innerHTML = `
                                <strong class="text-white">
                                    ${username} 
                                    ${message.is_staff ? 
                                        '<span class="badge bg-warning text-dark">conseiller</span>' : 
                                        '<span class="role-badge">utilisateur</span>'
                                    }
                                </strong>
                                <span class="message-timestamp">${formattedDate}</span>
                                <div class="text-white">${message.content}</div>
                            `;
                            
                            generalMessages.appendChild(messageElement);
                            generalMessages.scrollTop = generalMessages.scrollHeight;
                        }
                        else if (data.type === 'private_message') {
                            // Private message
                            const message = data.message;
                            const username = message.user_email.split('@')[0];
                            const formattedDate = formatDate(message.timestamp);
                            
                            // Check if this message concerns us
                            if (isStaff || message.user_email === currentUserEmail || 
                                message.recipient_email === currentUserEmail) {
                                
                                const messageElement = document.createElement('div');
                                messageElement.className = `message ${message.is_staff ? 'staff-message' : 'user-message'} p-2 mb-2`;
                                messageElement.dataset.messageId = message.id;
                                messageElement.dataset.userId = message.user_id;
                                messageElement.dataset.userEmail = message.user_email;
                                
                                let replyButton = '';
                                if (isStaff && !message.is_staff) {
                                    replyButton = `
                                        <div class="reply-actions mt-1">
                                            <button class="reply-btn btn btn-sm btn-outline-light" onclick="replyToMessage('${message.id}', '${message.user_id}', '${message.user_email}')">Répondre</button>
                                        </div>
                                    `;
                                }
                                
                                messageElement.innerHTML = `
                                    <strong class="text-white">
                                        ${username} 
                                        ${message.is_staff ? 
                                            '<span class="badge bg-warning text-dark">conseiller</span>' : 
                                            '<span class="role-badge">utilisateur</span>'
                                        }
                                    </strong>
                                    <span class="message-timestamp">${formattedDate}</span>
                                    <div class="text-white">${message.content}</div>
                                    ${replyButton}
                                `;
                                
                                privateMessages.appendChild(messageElement);
                                privateMessages.scrollTop = privateMessages.scrollHeight;
                            }
                        }
                        else if (data.type === 'user_join') {
                            // User joining
                            if (!onlineUsersList.has(data.user)) {
                                onlineUsersList.add(data.user);
                                updateOnlineUsersList();
                                
                                const username = data.user.split('@')[0];
                                const joinMessage = document.createElement('div');
                                joinMessage.className = 'text-center text-muted small my-2';
                                joinMessage.textContent = `${username} a rejoint le chat`;
                                generalMessages.appendChild(joinMessage);
                                generalMessages.scrollTop = generalMessages.scrollHeight;
                            }
                        }
                        else if (data.type === 'user_leave') {
                            // User leaving
                            if (onlineUsersList.has(data.user)) {
                                onlineUsersList.delete(data.user);
                                updateOnlineUsersList();
                                
                                const username = data.user.split('@')[0];
                                const leaveMessage = document.createElement('div');
                                leaveMessage.className = 'text-center text-muted small my-2';
                                leaveMessage.textContent = `${username} a quitté le chat`;
                                generalMessages.appendChild(leaveMessage);
                                generalMessages.scrollTop = generalMessages.scrollHeight;
                            }
                        }
                    } catch (error) {
                        console.error("Error processing WebSocket message:", error);
                    }
                };
                
                chatSocket.onclose = function(e) {
                    console.error('WebSocket closed unexpectedly. Code:', e.code, 'Reason:', e.reason);
                    
                    // Reconnection attempt with exponential back-off
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                        console.log(`Reconnecting in ${delay/1000} seconds... (Attempt ${reconnectAttempts})`);
                        
                        setTimeout(() => {
                            connectWebSocket();
                        }, delay);
                    } else {
                        console.error(`Failed to reconnect after ${maxReconnectAttempts} attempts.`);
                        // Show message to user
                        const connectionError = document.createElement('div');
                        connectionError.className = 'alert alert-danger m-3';
                        connectionError.innerHTML = `
                            <strong>Problème de connexion</strong>
                            <p>Impossible de se connecter au serveur de chat. Veuillez recharger la page.</p>
                            <button class="btn btn-sm btn-outline-danger" onclick="window.location.reload()">Recharger</button>
                        `;
                        generalMessages.prepend(connectionError);
                    }
                };
                
                chatSocket.onerror = function(e) {
                    console.error('WebSocket error:', e);
                };
                
                return chatSocket;
            } catch (error) {
                console.error('Error creating WebSocket connection:', error);
                return null;
            }
        }
        
        // Initialize WebSocket connection
        chatSocket = connectWebSocket();
        
        // General chat form
        generalForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const message = generalInput.value.trim();
            if (!message) return;
            
            // Send via WebSocket if possible
            if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                try {
                    chatSocket.send(JSON.stringify({
                        'message': message
                    }));
                } catch (error) {
                    console.error("Error sending via WebSocket:", error);
                }
            } else {
                console.warn('WebSocket not connected. Using HTTP fallback.');
            }
            
            // Always send via HTTP to ensure delivery
            fetch('/chat/api/send/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: `content=${encodeURIComponent(message)}`
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/accounts/login/?next=/chat/';
                    }
                    throw new Error('Sending error');
                }
                return response.json();
            })
            .catch(error => console.error('Error:', error));
            
            generalInput.value = '';
        });
        
        // Private chat form
        privateForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const message = privateInput.value.trim();
            if (!message) return;
            
            const recipient = recipientId.value;
            const replyTo = replyToId.value;
            
            // Build form data
            const formData = new FormData();
            formData.append('content', message);
            if (recipient) formData.append('recipient_id', recipient);
            if (replyTo) formData.append('reply_to_id', replyTo);
            
            // Convert FormData to URLEncoded
            const urlEncodedData = new URLSearchParams(formData).toString();
            
            // Send private message via WebSocket if possible
            if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                try {
                    chatSocket.send(JSON.stringify({
                        'type': 'private_message',
                        'message': message,
                        'recipient_id': recipient,
                        'reply_to_id': replyTo
                    }));
                } catch (error) {
                    console.error("Error sending private message via WebSocket:", error);
                }
            }
            
            // Always send via HTTP
            fetch('/chat/api/private/send/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: urlEncodedData
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/accounts/login/?next=/chat/';
                    }
                    throw new Error('Sending error');
                }
                return response.json();
            })
            .then(data => {
                console.log("Private message sent:", data);
                // Reset form
                privateInput.value = '';
                recipientId.value = '';
                replyToId.value = '';
                replyInfo.style.display = 'none';
            })
            .catch(error => console.error('Error:', error));
        });
        
        // Update online users list
        function updateOnlineUsersList() {
            onlineUsers.innerHTML = '';
            onlineCount.textContent = onlineUsersList.size;
            
            onlineUsersList.forEach(user => {
                const username = user.split('@')[0];
                
                const userElement = document.createElement('li');
                userElement.className = 'list-group-item d-flex align-items-center';
                userElement.style.backgroundColor = '#252525';
                userElement.style.border = '1px solid #333';
                userElement.style.marginBottom = '5px';
                userElement.style.color = '#fff';
                
                if (user === currentUserEmail) {
                    userElement.innerHTML = `
                        <div class="d-flex align-items-center">
                            <div class="avatar bg-primary me-2">
                                ${username.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <strong>${username}</strong>
                                <small class="text-muted d-block">(vous)</small>
                            </div>
                            <span class="role-badge ms-auto">
                                ${isStaff ? 'conseiller' : 'utilisateur'}
                            </span>
                        </div>
                    `;
                } else {
                    userElement.innerHTML = `
                        <div class="d-flex align-items-center w-100">
                            <div class="avatar bg-secondary me-2">
                                ${username.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                ${username}
                            </div>
                            <span class="role-badge ms-auto">utilisateur</span>
                        </div>
                    `;
                }
                
                onlineUsers.appendChild(userElement);
            });
        }
        
        // Get cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Refresh general messages
        function refreshGeneralMessages() {
            fetch('/chat/api/messages/')
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 401) {
                            window.location.href = '/accounts/login/?next=/chat/';
                        }
                        throw new Error('Error retrieving messages');
                    }
                    return response.json();
                })
                .then(data => {
                    // Refresh only if user is not typing
                    if (document.activeElement !== generalInput) {
                        // Get current message IDs
                        const currentMessageIds = Array.from(generalMessages.querySelectorAll('.message'))
                            .map(el => el.dataset.messageId);
                            
                        // Check for new messages
                        const newMessages = data.messages.filter(msg => 
                            !currentMessageIds.includes(msg.id.toString())
                        );
                        
                        if (newMessages.length > 0) {
                            const wasScrolledToBottom = generalMessages.scrollHeight - generalMessages.clientHeight <= generalMessages.scrollTop + 10;
                            
                            // Append only new messages
                            newMessages.forEach(message => {
                                const username = message.user_email.split('@')[0];
                                const formattedDate = formatDate(message.timestamp);
                                
                                const messageElement = document.createElement('div');
                                messageElement.className = `message ${message.is_staff ? 'staff-message' : 'user-message'} p-2 mb-2`;
                                messageElement.dataset.messageId = message.id;
                                
                                messageElement.innerHTML = `
                                    <strong class="text-white">
                                        ${username} 
                                        ${message.is_staff ? 
                                            '<span class="badge bg-warning text-dark">conseiller</span>' : 
                                            '<span class="role-badge">utilisateur</span>'
                                        }
                                    </strong>
                                    <span class="message-timestamp">${formattedDate}</span>
                                    <div class="text-white">${message.content}</div>
                                `;
                                
                                generalMessages.appendChild(messageElement);
                            });
                            
                            // Auto-scroll if was at bottom
                            if (wasScrolledToBottom) {
                                generalMessages.scrollTop = generalMessages.scrollHeight;
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error retrieving messages:', error);
                });
        }
        
        // Refresh private messages
        function refreshPrivateMessages() {
            fetch('/chat/api/private/messages/')
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/accounts/login/?next=/chat/';
                    }
                    throw new Error('Error retrieving private messages');
                }
                return response.json();
            })
            .then(data => {
                // Refresh only if user is not typing
                if (document.activeElement !== privateInput) {
                    // Get current message IDs
                    const currentMessageIds = Array.from(privateMessages.querySelectorAll('.message'))
                        .map(el => el.dataset.messageId);
                        
                    // Check for new messages
                    const newMessages = data.messages.filter(msg => 
                        !currentMessageIds.includes(msg.id.toString())
                    );
                    
                    if (newMessages.length > 0) {
                        const wasScrolledToBottom = privateMessages.scrollHeight - privateMessages.clientHeight <= privateMessages.scrollTop + 10;
                        
                        // Append only new messages
                        newMessages.forEach(message => {
                            const username = message.user_email.split('@')[0];
                            const formattedDate = formatDate(message.timestamp);
                            
                            const messageElement = document.createElement('div');
                            messageElement.className = `message ${message.is_staff ? 'staff-message' : 'user-message'} p-2 mb-2`;
                            messageElement.dataset.messageId = message.id;
                            messageElement.dataset.userId = message.user_id;
                            messageElement.dataset.userEmail = message.user_email;
                            
                            let replyButton = '';
                            if (isStaff && !message.is_staff) {
                                replyButton = `
                                    <div class="reply-actions mt-1">
                                        <button class="reply-btn btn btn-sm btn-outline-light" onclick="replyToMessage('${message.id}', '${message.user_id}', '${message.user_email}')">Répondre</button>
                                    </div>
                                `;
                            }
                            
                            messageElement.innerHTML = `
                                <strong class="text-white">
                                    ${username} 
                                    ${message.is_staff ? 
                                        '<span class="badge bg-warning text-dark">conseiller</span>' : 
                                        '<span class="role-badge">utilisateur</span>'
                                    }
                                </strong>
                                <span class="message-timestamp">${formattedDate}</span>
                                <div class="text-white">${message.content}</div>
                                ${replyButton}
                            `;
                            
                            privateMessages.appendChild(messageElement);
                        });
                        
                        // Auto-scroll if was at bottom
                        if (wasScrolledToBottom) {
                            privateMessages.scrollTop = privateMessages.scrollHeight;
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error retrieving private messages:', error);
            });
    }
    
    // Function to simulate online users for testing
    function simulateOnlineUsers() {
        // Add current user if not already in list
        if (currentUserEmail && !onlineUsersList.has(currentUserEmail)) {
            onlineUsersList.add(currentUserEmail);
        }
        
        // Check if we need to add test users
        if (onlineUsersList.size < 1) {
            console.log("Adding test users to online list");
            // Add some test users for demonstration
            onlineUsersList.add(currentUserEmail || "vous@example.com");
        }
        
        updateOnlineUsersList();
    }
    
    // Call once to ensure there are users shown
    simulateOnlineUsers();
    
    // Refresh messages regularly
    setInterval(refreshGeneralMessages, 1000);
    setInterval(refreshPrivateMessages, 1000);
    
    // Refresh online users list
    setInterval(simulateOnlineUsers, 30000);
    
    // Initial message refresh
    refreshGeneralMessages();
    refreshPrivateMessages();
});
</script>
{% endblock %}
{% extends 'base.html' %}

{% block content %}
<div id="chat-container" data-user-email="{{ user_info.email }}" class="container mt-5">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3>Chat général</h3>
                </div>
                <div class="card-body">
                    <div id="chat-messages" class="mb-3" style="height: 400px; overflow-y: auto;">
                        {% for message in messages %}
                            <div class="message mb-2 {% if message.is_staff %}staff-message{% else %}user-message{% endif %}">
                                <strong>
                                    {{ message.user.email }} 
                                    {% if message.is_staff %}
                                        <span class="badge bg-primary">staff</span>
                                    {% endif %}
                                </strong>
                                <span class="text-muted small">{{ message.formatted_timestamp }}</span>
                                <div>{{ message.content }}</div>
                            </div>
                        {% endfor %}
                    </div>
                    <form id="chat-form">
                        <div class="input-group">
                            <input type="text" id="chat-input" class="form-control" placeholder="Tapez votre message...">
                            <button type="submit" class="btn btn-primary">Envoyer</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h3>Utilisateurs en ligne</h3>
                </div>
                <div class="card-body">
                    <ul id="online-users" class="list-group">
                        <!-- Les utilisateurs en ligne seront ajoutés dynamiquement ici -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Chat script initialized");
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const onlineUsers = document.getElementById('online-users');
        const chatContainer = document.getElementById('chat-container');
        
        // Faire défiler vers le bas pour voir les messages les plus récents
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // Fonction pour formater les noms d'utilisateur dans les messages existants
        function formatExistingUsernames() {
            const messageElements = document.querySelectorAll('.message strong');
            messageElements.forEach(element => {
                const text = element.childNodes[0].textContent.trim();
                if (text.includes('@')) {
                    const username = text.split('@')[0];
                    element.childNodes[0].textContent = username + ' ';
                }
            });
        }
        
        // Formater les messages existants au chargement
        formatExistingUsernames();
        
        // Récupérer l'email de l'utilisateur actuel depuis l'attribut data
        const currentUserEmail = chatContainer.dataset.userEmail;
        console.log("Current user email:", currentUserEmail);
        
        // Liste des utilisateurs en ligne
        const onlineUsersList = new Set();
        
        // Ajouter l'utilisateur actuel à la liste des utilisateurs en ligne
        if (currentUserEmail) {
            onlineUsersList.add(currentUserEmail);
            updateOnlineUsersList();
            console.log("Added current user to online users list");
        }
        
        // Fonction pour établir la connexion WebSocket
        function connectWebSocket() {
            console.log("Attempting to connect WebSocket...");
            const chatSocket = new WebSocket(
                'ws://' + window.location.host + '/ws/chat/'
            );
            
            chatSocket.onopen = function(e) {
                console.log('WebSocket connection established');
                
                // Annoncer que l'utilisateur actuel rejoint le chat
                if (currentUserEmail) {
                    try {
                        chatSocket.send(JSON.stringify({
                            'type': 'user_join',
                            'user': currentUserEmail
                        }));
                        console.log("Sent user_join event for", currentUserEmail);
                    } catch (error) {
                        console.error("Error sending user_join event:", error);
                    }
                }
            };
            
            chatSocket.onmessage = function(e) {
                console.log("WebSocket message received:", e.data);
                try {
                    const data = JSON.parse(e.data);
                    
                    if (data.type === 'message') {
                        // Ajouter le nouveau message
                        const message = data.message;
                        // Extraire le nom d'utilisateur (partie avant le @)
                        const username = message.user_email.split('@')[0];
                        
                        const messageElement = document.createElement('div');
                        messageElement.className = `message mb-2 ${message.is_staff ? 'staff-message' : 'user-message'}`;
                        
                        messageElement.innerHTML = `
                            <strong>
                                ${username} 
                                ${message.is_staff ? '<span class="badge bg-primary">staff</span>' : ''}
                            </strong>
                            <span class="text-muted small">${message.timestamp}</span>
                            <div>${message.content}</div>
                        `;
                        
                        chatMessages.appendChild(messageElement);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        console.log("Added new message from", username);
                    }
                    else if (data.type === 'user_join') {
                        // Ajouter l'utilisateur à la liste des utilisateurs en ligne
                        if (!onlineUsersList.has(data.user)) {
                            onlineUsersList.add(data.user);
                            updateOnlineUsersList();
                            console.log("User joined:", data.user);
                            
                            // Afficher un message indiquant qu'un utilisateur a rejoint
                            const username = data.user.split('@')[0];
                            const joinMessage = document.createElement('div');
                            joinMessage.className = 'text-center text-muted small my-2';
                            joinMessage.textContent = `${username} a rejoint le chat`;
                            chatMessages.appendChild(joinMessage);
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                    }
                    else if (data.type === 'user_leave') {
                        // Retirer l'utilisateur de la liste des utilisateurs en ligne
                        if (onlineUsersList.has(data.user)) {
                            onlineUsersList.delete(data.user);
                            updateOnlineUsersList();
                            console.log("User left:", data.user);
                            
                            // Afficher un message indiquant qu'un utilisateur est parti
                            const username = data.user.split('@')[0];
                            const leaveMessage = document.createElement('div');
                            leaveMessage.className = 'text-center text-muted small my-2';
                            leaveMessage.textContent = `${username} a quitté le chat`;
                            chatMessages.appendChild(leaveMessage);
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                    }
                } catch (error) {
                    console.error("Error processing WebSocket message:", error);
                }
            };
            
            chatSocket.onclose = function(e) {
                console.error('WebSocket connection closed unexpectedly. Code:', e.code, 'Reason:', e.reason);
                // Tentative de reconnexion après 3 secondes
                setTimeout(function() {
                    console.log('Attempting to reconnect WebSocket...');
                    connectWebSocket();
                }, 3000);
            };
            
            chatSocket.onerror = function(e) {
                console.error('WebSocket error:', e);
            };
            
            return chatSocket;
        }
        
        // Initialiser la connexion WebSocket
        const chatSocket = connectWebSocket();
        
        // Envoyer un message
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const message = chatInput.value.trim();
            if (message) {
                console.log("Attempting to send message:", message);
                
                // Vérifier si la connexion WebSocket est ouverte
                if (chatSocket.readyState === WebSocket.OPEN) {
                    try {
                        chatSocket.send(JSON.stringify({
                            'message': message
                        }));
                        console.log("Message sent via WebSocket");
                    } catch (error) {
                        console.error("Error sending message via WebSocket:", error);
                    }
                } else {
                    console.error('WebSocket not connected. Message will be sent via HTTP only.');
                }
                
                // Envoyer également au serveur via HTTP pour s'assurer que le message est sauvegardé
                fetch('/chat/api/send/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: `content=${encodeURIComponent(message)}`
                })
                .then(response => {
                    console.log("HTTP send response status:", response.status);
                    if (!response.ok) {
                        if (response.status === 401) {
                            // Rediriger vers la page de connexion si non authentifié
                            window.location.href = '/accounts/login/?next=/chat/';
                        }
                        throw new Error('Erreur lors de l\'envoi du message');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Message sent successfully via HTTP:", data);
                })
                .catch(error => {
                    console.error('Erreur lors de l\'envoi du message via HTTP:', error);
                });
                
                chatInput.value = '';
            }
        });
        
        // Mettre à jour la liste des utilisateurs en ligne
        function updateOnlineUsersList() {
            onlineUsers.innerHTML = '';
            console.log("Updating online users list. Users count:", onlineUsersList.size);
            
            onlineUsersList.forEach(user => {
                // Extraire le nom d'utilisateur (partie avant le @)
                const username = user.split('@')[0];
                
                const userElement = document.createElement('li');
                userElement.className = 'list-group-item d-flex align-items-center';
                
                // Ajouter une icône ou un badge si c'est l'utilisateur actuel
                if (user === currentUserEmail) {
                    userElement.innerHTML = `
                        <span class="badge bg-success me-2">✓</span>
                        <strong>${username}</strong> <span class="text-muted ms-2">(vous)</span>
                    `;
                } else {
                    userElement.textContent = username;
                }
                
                onlineUsers.appendChild(userElement);
            });
        }
        
        // Fonction pour obtenir un cookie (pour CSRF)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Actualiser la liste des messages périodiquement
        function refreshMessages() {
            console.log("Refreshing messages...");
            fetch('/chat/api/messages/')
                .then(response => {
                    console.log("Messages refresh response status:", response.status);
                    if (!response.ok) {
                        if (response.status === 401) {
                            // Rediriger vers la page de connexion si non authentifié
                            window.location.href = '/accounts/login/?next=/chat/';
                        }
                        throw new Error('Erreur lors de la récupération des messages');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Received", data.messages.length, "messages");
                    
                    // Actualiser uniquement si le chat n'est pas en cours d'utilisation
                    if (document.activeElement !== chatInput) {
                        chatMessages.innerHTML = '';
                        
                        data.messages.forEach(message => {
                            // Extraire le nom d'utilisateur (partie avant le @)
                            const username = message.user_email.split('@')[0];
                            
                            const messageElement = document.createElement('div');
                            messageElement.className = `message mb-2 ${message.is_staff ? 'staff-message' : 'user-message'}`;
                            
                            messageElement.innerHTML = `
                                <strong>
                                    ${username} 
                                    ${message.is_staff ? '<span class="badge bg-primary">staff</span>' : ''}
                                </strong>
                                <span class="text-muted small">${message.timestamp}</span>
                                <div>${message.content}</div>
                            `;
                            
                            chatMessages.appendChild(messageElement);
                        });
                        
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                })
                .catch(error => {
                    console.error('Erreur lors de la récupération des messages:', error);
                });
        }
        
        // Function to simulate online users for testing
        function simulateOnlineUsers() {
            console.log("Simulating online users...");
            // Add current user if not already in list
            if (currentUserEmail && !onlineUsersList.has(currentUserEmail)) {
                onlineUsersList.add(currentUserEmail);
            }
            
            // Check if we need to add test users
            if (onlineUsersList.size < 1) {
                console.log("Adding test users to online list");
                // Add some test users for demonstration
                onlineUsersList.add(currentUserEmail || "vous@example.com");
            }
            
            updateOnlineUsersList();
        }
        
        // Call once to ensure there are users shown
        simulateOnlineUsers();
        
        // Actualiser les messages toutes les 10 secondes
        setInterval(refreshMessages, 10000);
        
        // Refresh online users list every 30 seconds
        setInterval(simulateOnlineUsers, 30000);
        
        // Initial message refresh
        refreshMessages();
    });
</script>
{% endblock %}
{% endblock %}
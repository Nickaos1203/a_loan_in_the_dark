{% extends 'base.html' %}

{% block content %}
<div id="chat-container" data-user-email="{{ user_info.email }}" data-user-id="{{user_info.id}}" data-is-staff="{{ user_info.is_staff|yesno:'true,false' }}" class="container mt-5">
    <!-- Onglets -->
    <div class="tabs">
        <div class="tab general active" onclick="switchTab('general')">Chat général</div>
        <div class="tab private" onclick="switchTab('private')">
            Chat privé
            {% if not user_info.is_staff %}
            <span class="badge bg-primary">Support</span>
            {% endif %}
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-8">
            <!-- Chat Général -->
            <div id="general-panel" class="chat-panel active">
                <div class="card chat-card">
                    <div class="card-header chat-header">
                        <h3 class="chat-title">Chat général</h3>
                    </div>
                    <div id="general-messages" class="chat-messages">
                        {% for message in public_messages %}
                            <div class="message {% if message.is_staff %}staff-message{% else %}user-message{% endif %}" data-message-id="{{ message.id }}">
                                <strong>
                                    {{ message.user.email }} 
                                    {% if message.is_staff %}
                                        <span class="badge bg-warning text-dark">conseiller</span>
                                    {% endif %}
                                </strong>
                                <span class="text-muted small">{{ message.formatted_timestamp }}</span>
                                <div>{{ message.content }}</div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="card-footer">
                        <form id="general-form">
                            <div class="input-group">
                                <input type="text" id="general-input" class="form-control" placeholder="Tapez votre message...">
                                <button type="submit" class="btn btn-primary">Envoyer</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Chat Privé -->
            <div id="private-panel" class="chat-panel">
                <div class="card chat-card">
                    <div class="card-header chat-header private-header">
                        <h3 class="chat-title">Chat privé</h3>
                        {% if user_info.is_staff %}
                        <small>Assistance client</small>
                        {% else %}
                        <small>Demandez de l'aide à nos conseillers</small>
                        {% endif %}
                    </div>
                    <div id="private-messages" class="chat-messages">
                        {% for message in private_messages %}
                            <div class="message {% if message.is_staff %}staff-message{% else %}user-message{% endif %}" 
                                 data-message-id="{{ message.id }}" 
                                 data-user-id="{{ message.user.id }}" 
                                 data-user-email="{{ message.user.email }}">
                                <strong>
                                    {{ message.user.email }} 
                                    {% if message.is_staff %}
                                        <span class="badge bg-warning text-dark">conseiller</span>
                                    {% endif %}
                                </strong>
                                <span class="text-muted small">{{ message.formatted_timestamp }}</span>
                                <div>{{ message.content }}</div>
                                {% if user_info.is_staff and not message.is_staff %}
                                <div class="reply-actions">
                                    <button class="reply-btn" onclick="replyToMessage('{{ message.id }}', '{{ message.user.id }}', '{{ message.user.email }}')">Répondre</button>
                                </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                    <div class="card-footer">
                        <div id="reply-info" class="reply-info">
                            Réponse à <span id="reply-user"></span>
                            <button type="button" class="btn-close float-end" onclick="cancelReply()"></button>
                        </div>
                        <form id="private-form">
                            <input type="hidden" id="recipient-id" value="">
                            <input type="hidden" id="reply-to-id" value="">
                            <div class="input-group">
                                <input type="text" id="private-input" class="form-control" placeholder="Message privé...">
                                <button type="submit" class="btn" style="background-color: var(--accent); color: #333;">Envoyer</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card chat-card">
                <div class="card-header chat-header">
                    <h3 class="chat-title">Utilisateurs en ligne</h3>
                </div>
                <div class="card-body">
                    <ul id="online-users" class="list-group">
                        <!-- Les utilisateurs en ligne seront ajoutés dynamiquement ici -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    // Fonction pour basculer entre les onglets
    function switchTab(tab) {
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.chat-panel').forEach(el => el.classList.remove('active'));
        
        document.querySelector(`.tab.${tab}`).classList.add('active');
        document.getElementById(`${tab}-panel`).classList.add('active');
    }
    
    // Fonction pour répondre à un message
    function replyToMessage(messageId, userId, userEmail) {
        document.getElementById('recipient-id').value = userId;
        document.getElementById('reply-to-id').value = messageId;
        
        const username = userEmail.split('@')[0];
        document.getElementById('reply-user').textContent = username;
        document.getElementById('reply-info').style.display = 'block';
        
        // Mettre le focus sur le champ de saisie
        document.getElementById('private-input').focus();
        
        // Passer à l'onglet privé
        switchTab('private');
    }
    
    // Fonction pour annuler une réponse
    function cancelReply() {
        document.getElementById('recipient-id').value = '';
        document.getElementById('reply-to-id').value = '';
        document.getElementById('reply-info').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log("Chat script initialized");
        
        // Éléments du DOM
        const generalMessages = document.getElementById('general-messages');
        const generalForm = document.getElementById('general-form');
        const generalInput = document.getElementById('general-input');
        
        const privateMessages = document.getElementById('private-messages');
        const privateForm = document.getElementById('private-form');
        const privateInput = document.getElementById('private-input');
        const recipientId = document.getElementById('recipient-id');
        const replyToId = document.getElementById('reply-to-id');
        const replyInfo = document.getElementById('reply-info');
        const replyUser = document.getElementById('reply-user');
        
        const onlineUsers = document.getElementById('online-users');
        const chatContainer = document.getElementById('chat-container');
        
        // Données utilisateur
        const currentUserEmail = chatContainer.dataset.userEmail;
        const currentUserId = chatContainer.dataset.userId;
        const isStaff = chatContainer.dataset.isStaff === 'true';
        
        console.log("User info:", currentUserEmail, isStaff);
        
        // Défiler vers le bas des messages
        generalMessages.scrollTop = generalMessages.scrollHeight;
        privateMessages.scrollTop = privateMessages.scrollHeight;
        
        // Formater les noms d'utilisateur existants
        function formatExistingUsernames() {
            document.querySelectorAll('.message strong').forEach(element => {
                const text = element.childNodes[0].textContent.trim();
                if (text.includes('@')) {
                    const username = text.split('@')[0];
                    element.childNodes[0].textContent = username + ' ';
                }
            });
        }
        
        formatExistingUsernames();
        
        // Liste des utilisateurs en ligne
        const onlineUsersList = new Set();
        
        // Ajouter l'utilisateur actuel
        if (currentUserEmail) {
            onlineUsersList.add(currentUserEmail);
            updateOnlineUsersList();
        }
        
        // Connecter WebSocket avec gestion d'erreur et reconnexion
        let chatSocket;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        
        function connectWebSocket() {
            console.log("Connecting to WebSocket...");
            
            try {
                // Créer une nouvelle connexion WebSocket
                chatSocket = new WebSocket(
                    'ws://' + window.location.host + '/ws/chat/'
                );
                
                chatSocket.onopen = function(e) {
                    console.log('WebSocket connection established');
                    reconnectAttempts = 0; // Réinitialiser le compteur de tentatives
                    
                    // Annoncer que l'utilisateur rejoint le chat
                    if (currentUserEmail) {
                        try {
                            chatSocket.send(JSON.stringify({
                                'type': 'user_join',
                                'user': currentUserEmail
                            }));
                        } catch (error) {
                            console.error("Error sending join event:", error);
                        }
                    }
                };
                
                chatSocket.onmessage = function(e) {
                    try {
                        const data = JSON.parse(e.data);
                        
                        if (data.type === 'message') {
                            // Message public
                            const message = data.message;
                            const username = message.user_email.split('@')[0];
                            
                            const messageElement = document.createElement('div');
                            messageElement.className = `message ${message.is_staff ? 'staff-message' : 'user-message'}`;
                            messageElement.dataset.messageId = message.id;
                            
                            messageElement.innerHTML = `
                                <strong>
                                    ${username} 
                                    ${message.is_staff ? '<span class="badge bg-warning text-dark">conseiller</span>' : ''}
                                </strong>
                                <span class="text-muted small">${message.timestamp}</span>
                                <div>${message.content}</div>
                            `;
                            
                            generalMessages.appendChild(messageElement);
                            generalMessages.scrollTop = generalMessages.scrollHeight;
                        }
                        else if (data.type === 'private_message') {
                            // Message privé
                            const message = data.message;
                            const username = message.user_email.split('@')[0];
                            
                            // Vérifier si ce message nous concerne
                            if (isStaff || message.user_email === currentUserEmail || 
                                message.recipient_email === currentUserEmail) {
                                
                                const messageElement = document.createElement('div');
                                messageElement.className = `message ${message.is_staff ? 'staff-message' : 'user-message'}`;
                                messageElement.dataset.messageId = message.id;
                                messageElement.dataset.userId = message.user_id;
                                messageElement.dataset.userEmail = message.user_email;
                                
                                let replyButton = '';
                                if (isStaff && !message.is_staff) {
                                    replyButton = `
                                        <div class="reply-actions">
                                            <button class="reply-btn" onclick="replyToMessage('${message.id}', '${message.user_id}', '${message.user_email}')">Répondre</button>
                                        </div>
                                    `;
                                }
                                
                                messageElement.innerHTML = `
                                    <strong>
                                        ${username} 
                                        ${message.is_staff ? '<span class="badge bg-warning text-dark">conseiller</span>' : ''}
                                    </strong>
                                    <span class="text-muted small">${message.timestamp}</span>
                                    <div>${message.content}</div>
                                    ${replyButton}
                                `;
                                
                                privateMessages.appendChild(messageElement);
                                privateMessages.scrollTop = privateMessages.scrollHeight;
                            }
                        }
                        else if (data.type === 'user_join') {
                            // Utilisateur rejoint
                            if (!onlineUsersList.has(data.user)) {
                                onlineUsersList.add(data.user);
                                updateOnlineUsersList();
                                
                                const username = data.user.split('@')[0];
                                const joinMessage = document.createElement('div');
                                joinMessage.className = 'text-center text-muted small my-2';
                                joinMessage.textContent = `${username} a rejoint le chat`;
                                generalMessages.appendChild(joinMessage);
                                generalMessages.scrollTop = generalMessages.scrollHeight;
                            }
                        }
                        else if (data.type === 'user_leave') {
                            // Utilisateur part
                            if (onlineUsersList.has(data.user)) {
                                onlineUsersList.delete(data.user);
                                updateOnlineUsersList();
                                
                                const username = data.user.split('@')[0];
                                const leaveMessage = document.createElement('div');
                                leaveMessage.className = 'text-center text-muted small my-2';
                                leaveMessage.textContent = `${username} a quitté le chat`;
                                generalMessages.appendChild(leaveMessage);
                                generalMessages.scrollTop = generalMessages.scrollHeight;
                            }
                        }
                    } catch (error) {
                        console.error("Error processing WebSocket message:", error);
                    }
                };
                
                chatSocket.onclose = function(e) {
                    console.error('WebSocket closed unexpectedly. Code:', e.code, 'Reason:', e.reason);
                    
                    // Tentative de reconnexion avec back-off exponentiel
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                        console.log(`Reconnecting in ${delay/1000} seconds... (Attempt ${reconnectAttempts})`);
                        
                        setTimeout(() => {
                            connectWebSocket();
                        }, delay);
                    } else {
                        console.error(`Failed to reconnect after ${maxReconnectAttempts} attempts.`);
                        // Afficher un message à l'utilisateur
                        const connectionError = document.createElement('div');
                        connectionError.className = 'alert alert-danger m-3';
                        connectionError.innerHTML = `
                            <strong>Problème de connexion</strong>
                            <p>Impossible de se connecter au serveur de chat. Veuillez recharger la page.</p>
                            <button class="btn btn-sm btn-outline-danger" onclick="window.location.reload()">Recharger</button>
                        `;
                        generalMessages.prepend(connectionError);
                    }
                };
                
                chatSocket.onerror = function(e) {
                    console.error('WebSocket error:', e);
                };
                
                return chatSocket;
            } catch (error) {
                console.error('Error creating WebSocket connection:', error);
                return null;
            }
        }
        
        // Initialiser la connexion WebSocket
        chatSocket = connectWebSocket();
        
        // Formulaire de chat général
        generalForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const message = generalInput.value.trim();
            if (!message) return;
            
            // Envoyer via WebSocket si possible
            if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                try {
                    chatSocket.send(JSON.stringify({
                        'message': message
                    }));
                } catch (error) {
                    console.error("Error sending via WebSocket:", error);
                }
            } else {
                console.warn('WebSocket not connected. Using HTTP fallback.');
            }
            
            // Toujours envoyer via HTTP pour garantir la livraison
            fetch('/chat/api/send/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: `content=${encodeURIComponent(message)}`
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/accounts/login/?next=/chat/';
                    }
                    throw new Error('Sending error');
                }
                return response.json();
            })
            .catch(error => console.error('Error:', error));
            
            generalInput.value = '';
        });
        
        // Formulaire de chat privé
        privateForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const message = privateInput.value.trim();
            if (!message) return;
            
            const recipient = recipientId.value;
            const replyTo = replyToId.value;
            
            // Construire les données du formulaire
            const formData = new FormData();
            formData.append('content', message);
            if (recipient) formData.append('recipient_id', recipient);
            if (replyTo) formData.append('reply_to_id', replyTo);
            
            // Convertir FormData en URLEncoded
            const urlEncodedData = new URLSearchParams(formData).toString();
            
            // Envoyer le message privé via WebSocket si possible
            if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                try {
                    chatSocket.send(JSON.stringify({
                        'type': 'private_message',
                        'message': message,
                        'recipient_id': recipient,
                        'reply_to_id': replyTo
                    }));
                } catch (error) {
                    console.error("Error sending private message via WebSocket:", error);
                }
            }
            
            // Toujours envoyer via HTTP
            fetch('/chat/api/private/send/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: urlEncodedData
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/accounts/login/?next=/chat/';
                    }
                    throw new Error('Sending error');
                }
                return response.json();
            })
            .then(data => {
                console.log("Private message sent:", data);
                // Réinitialiser le formulaire
                privateInput.value = '';
                recipientId.value = '';
                replyToId.value = '';
                replyInfo.style.display = 'none';
            })
            .catch(error => console.error('Error:', error));
        });
        
        // Mettre à jour la liste des utilisateurs en ligne
        function updateOnlineUsersList() {
            onlineUsers.innerHTML = '';
            
            onlineUsersList.forEach(user => {
                const username = user.split('@')[0];
                
                const userElement = document.createElement('li');
                userElement.className = 'list-group-item d-flex align-items-center';
                
                if (user === currentUserEmail) {
                    userElement.innerHTML = `
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center me-2" style="width: 32px; height: 32px;">
                                ${username.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <strong>${username}</strong>
                                <small class="text-muted d-block">(vous)</small>
                            </div>
                        </div>
                    `;
                } else {
                    userElement.innerHTML = `
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle bg-secondary text-white d-flex justify-content-center align-items-center me-2" style="width: 32px; height: 32px;">
                                ${username.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                ${username}
                            </div>
                        </div>
                    `;
                }
                
                onlineUsers.appendChild(userElement);
            });
        }
        
        // Obtenir un cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Actualiser les messages généraux
        function refreshGeneralMessages() {
            fetch('/chat/api/messages/')
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 401) {
                            window.location.href = '/accounts/login/?next=/chat/';
                        }
                        throw new Error('Erreur lors de la récupération des messages');
                    }
                    return response.json();
                })
                .then(data => {
                    // Actualiser uniquement si le panneau est actif et que l'utilisateur ne tape pas
                    if (document.getElementById('general-panel').classList.contains('active') && document.activeElement !== generalInput) {
                        generalMessages.innerHTML = '';
                        
                        data.messages.forEach(message => {
                            const username = message.user_email.split('@')[0];
                            
                            const messageElement = document.createElement('div');
                            messageElement.className = `message ${message.is_staff ? 'staff-message' : 'user-message'}`;
                            messageElement.dataset.messageId = message.id;
                            
                            messageElement.innerHTML = `
                                <strong>
                                    ${username} 
                                    ${message.is_staff ? '<span class="badge bg-warning text-dark">conseiller</span>' : ''}
                                </strong>
                                <span class="text-muted small">${message.timestamp}</span>
                                <div>${message.content}</div>
                            `;
                            
                            generalMessages.appendChild(messageElement);
                        });
                        
                        generalMessages.scrollTop = generalMessages.scrollHeight;
                    }
                })
                .catch(error => {
                    console.error('Erreur lors de la récupération des messages:', error);
                });
        }
        
        // Actualiser les messages privés
        function refreshPrivateMessages() {
          
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'text-center text-muted small my-1';
            loading.textContent = 'Actualisation...';
            loadingIndicator.id = 'private-loading';

            if (!document.getElementById('private-loading')){
                privateMessages.appendChild(loadingIndicator);
            }
        }

        fetch('/chat/api/private/messages/')
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/accounts/login/?next=/chat/';
                    }
                    throw new Error('Erreur lors de la récupération des messages privés');
                }
                return response.json();
            })
            .then(data => {
                console.log("Messages privés reçus:", data.messages.length);

                const currentMessageIds = Array.from(privateMessages.querySelectorAll('.message'))
                        .map(el => el.dataset.messageId);

                const loadingEl = document.getElementById('private-loading');
                if (loadingEl) {
                        privateMessages.removeChild(loadingEl);
                } 
                 
                const newMessages = data.messages.filter(msg => 
                !currentMessageIds.includes(msg.id.toString())
                );  
                
                if (newMessages.length>0){
                   console.log("Nouveaux messages privés à afficher:", newMessages.length);
                   
                   const wasScrolledToBottom = privateMessages.scrollHeight - privateMessages.clientHeight <= privateMessages.scrollTop + 10;

                }

            })
        
        // Function to simulate online users for testing
        function simulateOnlineUsers() {
            // Add current user if not already in list
            if (currentUserEmail && !onlineUsersList.has(currentUserEmail)) {
                onlineUsersList.add(currentUserEmail);
            }
            
            // Check if we need to add test users
            if (onlineUsersList.size < 1) {
                console.log("Adding test users to online list");
                // Add some test users for demonstration
                onlineUsersList.add(currentUserEmail || "vous@example.com");
            }
            
            updateOnlineUsersList();
        }
        
        // Call once to ensure there are users shown
        simulateOnlineUsers();
        
        // Actualiser les messages régulièrement
        setInterval(refreshGeneralMessages, 1000);
        setInterval(refreshPrivateMessages, 1000);
        
        // Rafraîchir la liste des utilisateurs en ligne
        setInterval(simulateOnlineUsers, 30000);
        
        // Initial message refresh
        refreshGeneralMessages();
        refreshPrivateMessages();
    });
</script>
{% endblock %}
{% endblock %}